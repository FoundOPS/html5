// Copyright 2012 FoundOPS LLC. All Rights Reserved.

require.config({waitSeconds:10,baseUrl:"js",paths:{lib:"../lib",ui:"ui",db:"db",underscore:"../lib/underscore"},shim:{underscore:{exports:"_"}}}),require(["jquery","lib/leaflet","developer","db/services","tools","ui/leaflet","ui/ui"],function($,l,developer,services,tools,leaflet,ui){var RESOURCES_REFRESH_RATE=1e4,map,center,resources,depotsGroup,resourcesGroup,routesGroup,trackPointsGroup,selectedDate,selectedRouteId,routesTrackPoints=[],routeColorSelector=new tools.ValueSelector(ui.ITEM_COLORS),routeOpacitySelector=new tools.ValueSelector(ui.ITEM_OPACITIES),removeLayer=function(layer){layer!=null&&map.removeLayer(layer)},drawResources=function(){removeLayer(resourcesGroup);var newTrackPoints=[],r;for(r in resources){var resource=resources[r],routeTrackPoints=routesTrackPoints[resource.RouteId];routeTrackPoints&&routeTrackPoints!=services.Status.LOADING&&(resource.EmployeeId!=null?resource.Id=resource.EmployeeId:resource.Id=resource.VehicleId,routeTrackPoints.push(resource),selectedRouteId&&(newTrackPoints.push(routeTrackPoints[routeTrackPoints.length-2]),newTrackPoints.push(resource)))}selectedRouteId&&trackPointsGroup.addLayer(leaflet.drawTrackPoints(map,newTrackPoints,resources,routeColorSelector,routeOpacitySelector,selectedRouteId)),resourcesGroup=leaflet.drawResources(map,resources,routeColorSelector,function(selectedRoute){setSelectedRoute(selectedRoute)})},drawTrackpoints=function(routeId){var routeTrackPoints=routesTrackPoints[routeId];if(routeTrackPoints===services.Status.LOADING)return;routeTrackPoints?trackPointsGroup=leaflet.drawTrackPoints(map,routeTrackPoints,resources,routeColorSelector,routeOpacitySelector,routeId):(routesTrackPoints[routeId]=services.Status.LOADING,services.getTrackPoints(tools.formatDate(selectedDate),routeId,function(loadedTrackPoints){selectedRouteId===routeId&&(removeLayer(trackPointsGroup),trackPointsGroup=leaflet.drawTrackPoints(map,loadedTrackPoints,resources,routeColorSelector,routeOpacitySelector,routeId)),routesTrackPoints[routeId]=loadedTrackPoints}))},getDepots=function(){removeLayer(depotsGroup),services.RoleId!=null&&services.getDepots(function(loadedDepots){depotsGroup=leaflet.drawDepots(map,loadedDepots)})},getResources=function(){services.RoleId!=null&&tools.dateEqual(selectedDate,new Date)&&(services.getResourcesWithLatestPoints(function(resourcesWithLatestPoints){resources=resourcesWithLatestPoints,drawResources()}),setTimeout(function(){getResources()},RESOURCES_REFRESH_RATE))},getRoutes=function(){services.RoleId!=null&&services.getRoutes(tools.formatDate(selectedDate),function(loadedRoutes){removeLayer(routesGroup),routesGroup=leaflet.drawRoutes(map,loadedRoutes,routeColorSelector,center,function(selectedRoute){setSelectedRoute(selectedRoute)}),center=!1,selectedRouteId&&setSelectedRoute(selectedRouteId)})},setDate=function(date){selectedDate=date,removeLayer(resourcesGroup),removeLayer(routesGroup),removeLayer(trackPointsGroup),center=!0,getRoutes(),getResources()},setSelectedRoute=function(routeId){selectedRouteId!=routeId&&(removeLayer(trackPointsGroup),selectedRouteId=routeId,drawTrackpoints(routeId))},initialize=function(){map=leaflet.setupMap(),map.on("click",function(){selectedRouteId=null,removeLayer(trackPointsGroup)}),setDate(new Date)};initialize();var functions={getRoutes:getRoutes,setDate:setDate,setRoleId:function(roleId){selectedRouteId=null,services.setRoleId(roleId),getDepots(),getRoutes(),getResources()},setSelectedRoute:setSelectedRoute};window.map=functions})