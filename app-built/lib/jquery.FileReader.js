(function($){var readyCallbacks=$.Callbacks("once unique memory"),inputsCount=0,currentTarget=null;$.fn.fileReader=function(options){options=$.extend({id:"fileReaderSWFObject",accept:null,label:null,extensions:null,multiple:!1,filereader:"lib/filereader.swf",expressInstall:null,debugMode:!1,callback:!1},options);var self=this;return readyCallbacks.add(function(){return main(self,options)}),$.isFunction(options.callback)&&readyCallbacks.add(options.callback),FileAPIProxy.ready||FileAPIProxy.init(options),this};var main=function(el,options){return el.each(function(i,input){input=$(input);var id=input.attr("id");id||(id="flashFileInput"+inputsCount,input.attr("id",id),inputsCount++),options.multiple=options.multiple===null?!!input.attr("multiple"):!!options.multiple,options.accept=options.accept===null?input.attr("accept"):options.multiple,FileAPIProxy.inputs[id]=input,FileAPIProxy.swfObject.add(id,options.multiple,options.accept,options.label,options.extensions),input.css("z-index",0).mouseover(function(e){e=e||window.event,currentTarget=id,FileAPIProxy.swfObject.mouseover(id),FileAPIProxy.container.height(input.outerHeight()).width(input.outerWidth()).position({of:input})}).click(function(e){return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1})})};window.FileAPIProxy={ready:!1,init:function(o){var self=this;this.debugMode=o.debugMode,this.container=$("<div>").attr("id",o.id).wrap("<div>").parent().css({width:"1px",height:"1px",display:"inline-block",background:"transparent",position:"absolute","z-index":99999}).on("mouseover mouseout mousedown mouseup",function(evt){currentTarget&&$("#"+currentTarget).trigger(evt.type)}).appendTo("body"),swfobject.embedSWF(o.filereader,o.id,"100%","100%","10",o.expressInstall,{debugMode:o.debugMode?!0:""},{wmode:"transparent",allowScriptAccess:"sameDomain"},{},function(e){self.swfObject=e.ref,$(self.swfObject).css({display:"block",outline:0}).attr("tabindex",0),self.ready&&readyCallbacks.fire(),self.ready=e.success})},swfObject:null,container:null,inputs:{},readers:{},onFileInputEvent:function(evt){this.debugMode&&console.info("FileInput Event ",evt.type,evt);if(evt.target in this.inputs){var el=this.inputs[evt.target];evt.target=el[0],evt.type==="change"&&(evt.files=new FileList(evt.files),evt.target={files:evt.files}),el.trigger(evt)}window.focus()},onFileReaderEvent:function(evt){this.debugMode&&console.info("FileReader Event ",evt.type,evt,evt.target in this.readers);if(evt.target in this.readers){var reader=this.readers[evt.target];evt.target=reader,reader._handleFlashEvent.call(reader,evt)}},onFileReaderError:function(error){this.debugMode&&console.log(error)},onSWFReady:function(){return this.ready&&readyCallbacks.fire(),this.ready=!0,!0}},window.FileReader=function(){this.EMPTY=0,this.LOADING=1,this.DONE=2,this.readyState=0,this.result=null,this.error=null,this.onloadstart=null,this.onprogress=null,this.onload=null,this.onabort=null,this.onerror=null,this.onloadend=null,this._callbacks={loadstart:$.Callbacks("unique"),progress:$.Callbacks("unique"),abort:$.Callbacks("unique"),error:$.Callbacks("unique"),load:$.Callbacks("unique"),loadend:$.Callbacks("unique")},this._id=null},window.FileReader.prototype={readAsBinaryString:function(file){this._start(file),FileAPIProxy.swfObject.read(file.input,file.name,"readAsBinaryString")},readAsText:function(file,encoding){this._start(file),FileAPIProxy.swfObject.read(file.input,file.name,"readAsText")},readAsDataURL:function(file){this._start(file),FileAPIProxy.swfObject.read(file.input,file.name,"readAsDataURL")},readAsArrayBuffer:function(file){throw"Whoops FileReader.readAsArrayBuffer is unimplemented"},abort:function(){this.result=null;if(this.readyState===this.EMPTY||this.readyState===this.DONE)return;FileAPIProxy.swfObject.abort(this._id)},addEventListener:function(type,listener){type in this._callbacks&&this._callbacks[type].add(listener)},removeEventListener:function(type,listener){type in this._callbacks&&this._callbacks[type].remove(listener)},dispatchEvent:function(event){event.target=this;if(event.type in this._callbacks){var fn=this["on"+event.type];$.isFunction(fn)&&fn(event),this._callbacks[event.type].fire(event)}return!0},_register:function(file){this._id=file.input+"."+file.name,FileAPIProxy.readers[this._id]=this},_start:function(file){this._register(file);if(this.readyState===this.LOADING)throw{type:"InvalidStateError",code:11,message:"The object is in an invalid state."}},_handleFlashEvent:function(evt){switch(evt.type){case"loadstart":this.readyState=this.LOADING;break;case"loadend":this.readyState=this.DONE;break;case"load":this.readyState=this.DONE,this.result=FileAPIProxy.swfObject.result(this._id);break;case"error":this.result=null,this.error={name:"NotReadableError",message:"The File cannot be read!"}}this.dispatchEvent(new FileReaderEvent(evt))}},FileReaderEvent=function(e){this.initEvent(e)},FileReaderEvent.prototype={initEvent:function(event){$.extend(this,{type:null,target:null,currentTarget:null,eventPhase:2,bubbles:!1,cancelable:!1,defaultPrevented:!1,isTrusted:!1,timeStamp:(new Date).getTime()},event)},stopPropagation:function(){},stopImmediatePropagation:function(){},preventDefault:function(){}},FileList=function(array){if(array){for(var i=0;i<array.length;i++)this[i]=array[i];this.length=array.length}else this.length=0},FileList.prototype={item:function(index){return index in this?this[index]:null}}})(jQuery)