/*
* @Copyright (c) 2011 Aur√©lio Saraiva, Diego Plentz
* @Page http://github.com/plentz/jquery-maskmoney
* try at http://plentz.org/maskmoney

* Permission is hereby granted, free of charge, to any person
* obtaining a copy of this software and associated documentation
* files (the "Software"), to deal in the Software without
* restriction, including without limitation the rights to use,
* copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the
* Software is furnished to do so, subject to the following
* conditions:
* The above copyright notice and this permission notice shall be
* included in all copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
* OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
* HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
* WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
* OTHER DEALINGS IN THE SOFTWARE.
*/

(function($){$.fn.maskMoney=function(settings){return settings=$.extend({symbol:"US$",showSymbol:!1,symbolStay:!1,thousands:",",decimal:".",precision:2,defaultZero:!0,allowZero:!1,allowNegative:!1},settings),this.each(function(){function markAsDirty(){dirty=!0}function clearDirt(){dirty=!1}function keypressEvent(e){e=e||window.event;var k=e.charCode||e.keyCode||e.which;if(k==undefined)return!1;if(input.attr("readonly")&&k!=13&&k!=9)return!1;if(k<48||k>57)return k==45?(markAsDirty(),input.val(changeSign(input)),!1):k==43?(markAsDirty(),input.val(input.val().replace("-","")),!1):k==13||k==9?(dirty&&(clearDirt(),$(this).change()),!0):k==37||k==39?!0:(preventDefault(e),!0);if(input.val().length>=input.attr("maxlength"))return!1;preventDefault(e);var key=String.fromCharCode(k),x=input.get(0),selection=input.getInputSelection(x),startPos=selection.start,endPos=selection.end;return x.value=x.value.substring(0,startPos)+key+x.value.substring(endPos,x.value.length),maskAndPosition(x,startPos+1),markAsDirty(),!1}function keydownEvent(e){e=e||window.event;var k=e.charCode||e.keyCode||e.which;if(k==undefined)return!1;if(input.attr("readonly")&&k!=13&&k!=9)return!1;var x=input.get(0),selection=input.getInputSelection(x),startPos=selection.start,endPos=selection.end;return k==8?(preventDefault(e),startPos==endPos?(x.value=x.value.substring(0,startPos-1)+x.value.substring(endPos,x.value.length),startPos-=1):x.value=x.value.substring(0,startPos)+x.value.substring(endPos,x.value.length),maskAndPosition(x,startPos),markAsDirty(),!1):k==9?(dirty&&($(this).change(),clearDirt()),!0):k==46||k==63272?(preventDefault(e),x.selectionStart==x.selectionEnd?x.value=x.value.substring(0,startPos)+x.value.substring(endPos+1,x.value.length):x.value=x.value.substring(0,startPos)+x.value.substring(endPos,x.value.length),maskAndPosition(x,startPos),markAsDirty(),!1):!0}function focusEvent(e){var mask=getDefaultMask();input.val()==mask?input.val(""):input.val()==""&&settings.defaultZero?input.val(setSymbol(mask)):input.val(setSymbol(input.val()));if(this.createTextRange){var textRange=this.createTextRange();textRange.collapse(!1),textRange.select()}}function blurEvent(e){$.browser.msie&&keypressEvent(e),input.val()==""||input.val()==setSymbol(getDefaultMask())||input.val()==settings.symbol?settings.allowZero?settings.symbolStay?input.val(setSymbol(getDefaultMask())):input.val(getDefaultMask()):input.val(""):settings.symbolStay?settings.symbolStay&&input.val()==settings.symbol&&input.val(setSymbol(getDefaultMask())):input.val(input.val().replace(settings.symbol,""))}function preventDefault(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function maskAndPosition(x,startPos){var originalLen=input.val().length;input.val(maskValue(x.value));var newLen=input.val().length;startPos-=originalLen-newLen,input.setCursorPosition(startPos)}function maskValue(v){v=v.replace(settings.symbol,"");var strCheck="0123456789",len=v.length,a="",t="",neg="";len!=0&&v.charAt(0)=="-"&&(v=v.replace("-",""),settings.allowNegative&&(neg="-"));if(len==0){if(!settings.defaultZero)return t;t="0.00"}for(var i=0;i<len;i++)if(v.charAt(i)!="0"&&v.charAt(i)!=settings.decimal)break;for(;i<len;i++)strCheck.indexOf(v.charAt(i))!=-1&&(a+=v.charAt(i));var n=parseFloat(a);n=isNaN(n)?0:n/Math.pow(10,settings.precision),t=n.toFixed(settings.precision),i=settings.precision==0?0:1;var p,d=(t=t.split("."))[i].substr(0,settings.precision);for(p=(t=t[0]).length;(p-=3)>=1;)t=t.substr(0,p)+settings.thousands+t.substr(p);return settings.precision>0?setSymbol(neg+t+settings.decimal+d+Array(settings.precision+1-d.length).join(0)):setSymbol(neg+t)}function mask(){var value=input.val();input.val(maskValue(value))}function getDefaultMask(){var n=parseFloat("0")/Math.pow(10,settings.precision);return n.toFixed(settings.precision).replace(new RegExp("\\.","g"),settings.decimal)}function setSymbol(v){return settings.showSymbol&&v.substr(0,settings.symbol.length)!=settings.symbol?settings.symbol+v:v}function changeSign(i){if(settings.allowNegative){var vic=i.val();return i.val()!=""&&i.val().charAt(0)=="-"?i.val().replace("-",""):"-"+i.val()}return i.val()}var input=$(this),dirty=!1;input.bind("keypress.maskMoney",keypressEvent),input.bind("keydown.maskMoney",keydownEvent),input.bind("blur.maskMoney",blurEvent),input.bind("focus.maskMoney",focusEvent),input.bind("mask",mask),input.one("unmaskMoney",function(){input.unbind(".maskMoney"),$.browser.msie?this.onpaste=null:$.browser.mozilla&&this.removeEventListener("input",blurEvent,!1)})})},$.fn.unmaskMoney=function(){return this.trigger("unmaskMoney")},$.fn.mask=function(){return this.trigger("mask")},$.fn.setCursorPosition=function(pos){return this.each(function(index,elem){if(elem.setSelectionRange)elem.focus(),elem.setSelectionRange(pos,pos);else if(elem.createTextRange){var range=elem.createTextRange();range.collapse(!0),range.moveEnd("character",pos),range.moveStart("character",pos),range.select()}}),this},$.fn.getInputSelection=function(el){var start=0,end=0,normalizedValue,range,textInputRange,len,endRange;return typeof el.selectionStart=="number"&&typeof el.selectionEnd=="number"?(start=el.selectionStart,end=el.selectionEnd):(range=document.selection.createRange(),range&&range.parentElement()==el&&(len=el.value.length,normalizedValue=el.value.replace(/\r\n/g,"\n"),textInputRange=el.createTextRange(),textInputRange.moveToBookmark(range.getBookmark()),endRange=el.createTextRange(),endRange.collapse(!1),textInputRange.compareEndPoints("StartToEnd",endRange)>-1?start=end=len:(start=-textInputRange.moveStart("character",-len),start+=normalizedValue.slice(0,start).split("\n").length-1,textInputRange.compareEndPoints("EndToEnd",endRange)>-1?end=len:(end=-textInputRange.moveEnd("character",-len),end+=normalizedValue.slice(0,end).split("\n").length-1)))),{start:start,end:end}}})(jQuery)