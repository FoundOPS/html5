// Copyright 2012 FoundOPS LLC. All Rights Reserved.

define(["lib/noty"],function(){var saveHistory={},successText="Your Changes Have Been Saved.",errorText="Error - Your Changes May Not Have Been Saved";return saveHistory.states=[],saveHistory.setCurrentSection=function(options){saveHistory.close(),saveHistory.options=options,saveHistory.resetHistory()},saveHistory.success=function(text){text||(text=successText);var timeout=0;if(saveHistory.states.length>1){var numChanges=saveHistory.states.length-1;numChanges>1?text+="&nbsp;&nbsp;&nbsp;<br/><a onclick='saveHistory.undo(true)' style='position:relative; top:3px;'>Undo All Changes to "+saveHistory.options.page+"</a>&nbsp;&nbsp;&nbsp;<br/><a onclick='saveHistory.undo(false)' style='position:relative; top:4px;'>Undo Last Change</a>":text+="&nbsp;&nbsp;&nbsp;<a onclick='saveHistory.undo(true)'>Undo</a>"}else timeout=5e3;$.noty({type:"success",layout:"topCenter",easing:"swing",text:text,speed:300,timeout:timeout,closeOnSelfClick:!1})},saveHistory.error=function(code){var text=errorText;code==="Conflict"?text="Error - A User Already Exists With That Email Address":code==="Get"?text="Connection Error":code==="File Size"?text="File is Too Large! Maximum Allowed is 5MB.":code==="File Type"&&(text="Only .JPG, .PNG, and .GIF Files Types Allowed!"),$.noty({type:"error",layout:"topCenter",easing:"swing",text:text,speed:300})},saveHistory.close=function(){$.noty.closeAll()},saveHistory.linkNotification=function(ajax){return ajax.success(function(){saveHistory.success()}).error(function(data,textStatus,jqXHR){saveHistory.error(jqXHR)})},saveHistory.resetHistory=function(){saveHistory.states=[];if(saveHistory.options.state){var state=saveHistory.options.state();if(!state)return;state=JSON.parse(JSON.stringify(state)),saveHistory.states.push(state)}},saveHistory.save=function(){if(saveHistory.options.state){var state=saveHistory.options.state();if(!state)return;state=JSON.parse(JSON.stringify(state)),saveHistory.states.push(state)}saveHistory.close(),saveHistory.options.save()},saveHistory.undo=function(cancelAll){saveHistory.states.pop();var state;cancelAll?(state=saveHistory.states[0],saveHistory.states=[],saveHistory.states.push(state)):state=saveHistory.states[saveHistory.states.length-1],saveHistory.close(),saveHistory.options.undo(state)},saveHistory.saveInputChanges=function(pageDiv){$(pageDiv+" input,"+pageDiv+" textarea").each(function(){$(this).on("change",function(){_.delay(function(){saveHistory.save()},200)})})},window.saveHistory=saveHistory,saveHistory})