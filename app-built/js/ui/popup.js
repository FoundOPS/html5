function Popup(popupListener){var history=[],thisPopup=this,title="",content="",object=null;if(typeof popupListener=="undefined"||popupListener===null){console.log("ERROR: No listener passed!");return}var listenerElements=$(popupListener);listenerElements.addClass("popupListener"),listenerElements.css("cursor","pointer"),listenerElements.click(function(e){thisPopup.toggleVisible(e,$(this))}),this.addMenu=function(id,title,contents){menus.push({id:id,title:title,contents:contents})},this.toggleVisible=function(e,clicked){var clickedDiv=$(clicked);if(clickedDiv===null){console.log("ERROR: No element clicked!");return}var popupWrapperDiv=$("#popupWrapper");if(popupWrapperDiv.length===0){popupWrapperDiv=this.createPopup();if(popupWrapperDiv.length===0){console.log("ERROR: Failed to create Popup!");return}}var id=clickedDiv.attr("id");if($("#popup").is(":visible")&&lastElementClick!==null){if(clickedDiv.is("#"+lastElementClick)){console.log("Clicked on same element!"),this.closePopup();return}console.log("Clicked on different element!"),this.closePopup()}$("#popup").promise().done(function(){});var left=this.getLeft(clickedDiv,popupWrapperDiv);popupWrapperDiv.css("left",left);var top=clickedDiv.outerHeight()+clickedDiv.offset().top-$(window).scrollTop()+ -1*parseInt($("#popupArrow").css("margin-top"),10);popupWrapperDiv.css("padding-top",top+"px"),this.populate(id),clickedDiv.trigger("popupEvent",clickedDiv),$("#popup").stop(!1,!0).fadeIn("fast"),popupWrapperDiv.trigger("popup.visible"),lastElementClick=clickedDiv.attr("id")},this.getLeft=function(target,popupDiv){var padding=3;currentTarget=target;var x=target.offset().left+target.outerWidth()/2,rightOffset=x+popupDiv.outerWidth()/2,offset=x-popupDiv.outerWidth()/2+padding+1,windowWidth=$(window).width(),offScreen=!1,carrotPos="50%";offset<0?(offScreen=!0,offset=padding):rightOffset>windowWidth&&(offScreen=!0,offset=windowWidth-popupDiv.outerWidth());var carrot=$("#popupArrow");return offScreen&&(carrotPos=x-offset+padding),carrot.css("left",carrotPos),offset},this.createPopup=function(){var popupWrapperDiv=$(document.createElement("div"));popupWrapperDiv.attr("id","popupWrapper");var s="<div id='popup'><div id='popupArrow'></div><div id='currentPopupAction' style='display: none;'></div><div id='popupHeader'><a id='popupBack'></a><div id='popupTitle'></div><a id='popupClose'></a></div><div id='popupContentWrapper'><div id='popupContent'></div></div></div>";popupWrapperDiv.html(s),popupWrapperDiv.find("#popup").css("display","none"),$("body").prepend(popupWrapperDiv),$("#popupClose").click(function(){thisPopup.closePopup()}),$("#popupBack").click(function(){history.pop();if(history.length<=0){thisPopup.closePopup();return}thisPopup.setData(history[history.length-1])}),$(window).on("resize",function(){var popupWrapperDiv=$("#popupWrapper");if($("#popup").is(":visible")){var left=thisPopup.getLeft(currentTarget,popupWrapperDiv);popupWrapperDiv.css("left",left);var top=$(currentTarget).outerHeight()+$(currentTarget).offset().top-$(window).scrollTop()+ -1*parseInt($("#popupArrow").css("margin-top"),10);popupWrapperDiv.css("padding-top",top+"px")}}),$("html").on("click touchend",function(e){var clicked=$(e.target),popupHeaderLen=clicked.parents("#popupHeader").length+clicked.is("#popupHeader")?1:0,popupContentLen=clicked.parents("#popupContent").length+clicked.is("#popupContent")?1:0,isListener=clicked.parents(".popupListener").length+clicked.is(".popupListener")?1:0;popupHeaderLen===0&&popupContentLen===0&&isListener===0&&thisPopup.closePopup()}),$(document).on("touchstart mousedown","#popup a",function(){$(this).css({backgroundColor:"#488FCD"})}).on("touchend mouseup mouseout","#popup a",function(){$(this).css({backgroundColor:""})}).on("click",".popupContentRow",function(){var newId=$(this).attr("id");$(this).hasClass("popupEvent")&&$(this).trigger("popupEvent",$(this));var keepOpen=thisPopup.populate(newId);keepOpen||thisPopup.closePopup()}),object=popupWrapperDiv;var popupContentWrapperDiv=$("#popupContentWrapper"),throttleTimeout;return $(window).bind("resize",function(){$.browser.msie?throttleTimeout||(throttleTimeout=setTimeout(function(){popupContentWrapperDiv.trigger("popup.resize"),throttleTimeout=null},50)):popupContentWrapperDiv.trigger("popup.resize")}),popupContentWrapperDiv.trigger("popup.created"),popupWrapperDiv},this.closePopup=function(){history=[],$("#popup").stop(!1,!0).fadeOut("fast")},this.populate=function(id){var newMenu=this.getMenu(id);return newMenu===null?!1:(history.push(newMenu),this.setData(newMenu),!0)},this.setData=function(data){var contArray=data.contents,c="",i;for(i=0;i<contArray.length;i++){var lastElement="",popupEvent="",menuId="",menuUrl="";i===contArray.length-1&&(lastElement=" last"),typeof contArray[i].id!="undefined"&&(menuId=" id='"+contArray[i].id+"'"),typeof contArray[i].url!="undefined"?menuUrl=" href='"+contArray[i].url+"'":popupEvent=" popupEvent",c+="<a"+menuUrl+menuId+" class='popupContentRow"+popupEvent+lastElement+"'>"+contArray[i].name+"</a>"}this.setAction(data.id),this.setTitle(data.title),this.setContent(c)},this.getAction=function(){return $("#currentPopupAction").html()},this.setAction=function(id){$("#currentPopupAction").html(id)},this.setTitle=function(t){title=t,$("#popupTitle").html(title)},this.setContent=function(cont){content=cont;var popupContentWrapperDiv=$("#popupContentWrapper");$("#popupContent").html(content),popupContentWrapperDiv.trigger("popup.setContent",$(this))},this.getMenu=function(id){var i;for(i=0;i<menus.length;i+=1)if(menus[i].id===id)return menus[i];return null}}(function($){var popup=null,methods={init:function(options){popup=new Popup(this.selector),popup.addMenu(options.id,options.title,options.contents)},addMenu:function(menu){if(popup===null)return;popup.addMenu(menu.id,menu.title,menu.contents)},closePopup:function(){popup.closePopup()}};$.fn.popup=function(method){return methods[method]?methods[method].apply(this,Array.prototype.slice.call(arguments,1)):typeof method=="object"||!method?methods.init.apply(this,arguments):($.error("Method "+method+" does not exist on jQuery.popup"),this.each(function(){}))}})(jQuery);var menus=[],lastElementClick=null,currentTarget=null