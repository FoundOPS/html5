define(["db/services","db/session"],function(dbServices,session){var silverlight={},currentSection;window.silverlight=silverlight;var resizeContainers=function(){if(!currentSection||!currentSection.isSilverlight)return;var height=$(window).height()-45,width=$("#content").width();$("#silverlightControlHost").height(height),$("#silverlightControlHost").width(width),$("#remoteContent").height(height),$("#remoteContent").width(width)},hide=function(){$("#silverlightControlHost").css("height","0px"),$("#silverlightControlHost").css("width","0px"),$("#silverlightPlugin").css("height","1px"),$("#silverlightPlugin").css("width","1px"),$("#remoteContent").css("display","")},show=function(){$("#silverlightPlugin").css("height","100%"),$("#silverlightPlugin").css("width","100%"),$("#remoteContent").css("display","none"),_.delay(resizeContainers,150)};return window.onhashchange=function(){if(!location||!location.hash)return;location.hash.indexOf("silverlight")===-1&&(hide(),currentSection=null)},window.openImporter=function(){silverlight.setSection({name:"Importer",isSilverlight:!0})},window.onSilverlightError=function(sender,args){var appSource="";sender!=null&&sender!=0&&(appSource=sender.getHost().Source);var errorType=args.ErrorType,iErrorCode=args.ErrorCode;if(errorType==="ImageError"||errorType==="MediaError")return;var errMsg="Unhandled Error in Silverlight Application "+appSource+"\n";throw errMsg+="Code: "+iErrorCode+"    \n",errMsg+="Category: "+errorType+"       \n",errMsg+="Message: "+args.ErrorMessage+"     \n",errorType==="ParserError"?(errMsg+="File: "+args.xamlFile+"     \n",errMsg+="Line: "+args.lineNumber+"     \n",errMsg+="Position: "+args.charPosition+"     \n"):errorType==="RuntimeError"&&(args.lineNumber!==0&&(errMsg+="Line: "+args.lineNumber+"     \n",errMsg+="Position: "+args.charPosition+"     \n"),errMsg+="MethodName: "+args.methodName+"     \n"),console.log(errMsg),new Error(errMsg)},window.onSourceDownloadProgressChanged=function(sender,eventArgs){var myText=sender.findName("progressText");myText.Text=Math.round(eventArgs.progress*100).toString();var myBar=sender.findName("ProgressBarTransform");myBar.ScaleX=eventArgs.progress},silverlight.onLoaded=function(){silverlight.plugin=document.getElementById("silverlightPlugin").Content,session.followRole(function(role){try{role&&silverlight.plugin.navigationVM.ChangeRole(role.get("id"))}catch(err){}}),currentSection&&silverlight.setSection(currentSection),$(silverlight).trigger("loaded")},silverlight.httpGetImage=function(url){var img=new Image;img.src=url},silverlight.setSection=function(section){currentSection=section;if(!section.isSilverlight){hide();return}show();try{silverlight.plugin.navigationVM.NavigateToView(section.name)}catch(err){}},hide(),$(window).resize(resizeContainers),resizeContainers(),silverlight})