// Copyright 2012 FoundOPS LLC. All Rights Reserved.

define(["db/session","db/services"],function(session,dbServices){var gridTools={};return gridTools.storeConfiguration=function(grid,id){var saveConfiguration=function(){gridTools._saveConfigurations(grid.columns,id)};grid.bind("columnReorder",saveConfiguration),grid.bind("columnResize",saveConfiguration),grid.bind("columnShow",saveConfiguration),grid.bind("columnHide",saveConfiguration)},gridTools._saveConfigurations=_.debounce(function(gridColumns,id){var columnConfiguration={Id:id,Columns:[]},order=0;_.each(gridColumns,function(gridColumn){var storedColumn={};storedColumn.Name=gridColumn.field,storedColumn.Width=gridColumn.width,storedColumn.Order=order,order++,storedColumn.Hidden=gridColumn.hidden,columnConfiguration.Columns.push(storedColumn)});var newConfigurations=_.reject(gridTools._columnConfigurations,function(config){return config.Id===id});newConfigurations.push(columnConfiguration),gridTools._columnConfigurations=newConfigurations,dbServices.updateColumnConfigurations(newConfigurations)},300),gridTools.configureColumns=function(gridColumns,id){var configuration=_.find(gridTools._columnConfigurations,function(configuration){return configuration.Id===id}),storedColumns=[];configuration&&(storedColumns=configuration.Columns),_.each(gridColumns,function(column){var storedColumn=_.find(storedColumns,function(col){return col.Name===column.field});storedColumn&&(storedColumn.Width.indexOf("px")===-1&&(storedColumn.Width+="px"),column.width=storedColumn.Width,column.hidden=storedColumn.Hidden,column.order=storedColumn.Order)});var storedCols=_.pluck(storedColumns,"Name"),gridCols=_.pluck(gridColumns,"field");return(_.difference(storedCols,gridCols).length>0||_.difference(gridCols,storedCols).length>0)&&gridTools._saveConfigurations(gridColumns,id),gridColumns=_.sortBy(gridColumns,function(column){return"order"in column?parseInt(column.order):100}),gridColumns},session.followRole(function(){dbServices.getColumnConfigurations(function(configurations){gridTools._columnConfigurations=configurations})}),gridTools.toCSV=function(data,fileName,humanize,ignore){var csv="";ignore||(ignore=[]),ignore=_.union(ignore,["_events","idField","_defaultId","constructor","init","get","_set","wrap","bind","one","first","trigger","unbind","uid","dirty","id","parent"]);if(data.length>0){for(var col in data[0]){if(!data[0].hasOwnProperty(col)||_.include(ignore,col))continue;humanize&&(col=col.split("_").join(" ").replace(/([A-Z])/g," $1")),col=col.replace(/"/g,'""'),csv+='"'+col+'"',col!=data[0].length-1&&(csv+=",")}csv+="\n"}for(var row in data){for(var col in data[row]){if(!data[row].hasOwnProperty(col)||_.include(ignore,col))continue;var value=data[row][col];value===null?value="":value instanceof Date?value=moment(value).format("MM/D/YYYY"):value=value.toString(),value=value.replace(/"/g,'""'),csv+='"'+value+'"',col!==data[row].length-1&&(csv+=",")}csv+="\n"}return csv},gridTools})