// Copyright 2012 FoundOPS LLC. All Rights Reserved.

define(["tools","db/services","db/session","db/saveHistory","widgets/settingsMenu","ui/colorPicker","ui/kendoChanges"],function(tools,dbServices,session,saveHistory){var dispatcherSettings={},busAcctId,selectedItem;dispatcherSettings.initialize=function(){var menu=$("#dispatcher .settingsMenu");kendo.bind(menu),menu.kendoSettingsMenu({selectedItem:"Dispatcher"});var dataSource=new kendo.data.DataSource({transport:{read:{type:"GET",dataType:"jsonp",contentType:"application/json; charset=utf-8"},update:{type:"POST"},destroy:{type:"POST"},create:{type:"POST"}},schema:{model:{id:"Id",fields:{Id:{type:"hidden"},BusinessAccountId:{type:"hidden"},Name:{type:"string",validation:{required:!0},defaultValue:"New Status"},Color:{type:"string",defaultValue:"#FFFFFF"},RouteRequired:{type:"boolean"},DefaultTypeInt:{type:"number",editable:!1,defaultValue:null}}}}});dbServices.hookupDefaultComplete(dataSource),session.followRole(function(role){var roleId=session.get("role.id");if(!roleId)return;dataSource.transport.options.read.url=dbServices.API_URL+"taskStatuses/GetStatuses?roleId="+roleId,dataSource.transport.options.update.url=dbServices.API_URL+"taskStatuses/UpdateTaskStatus?roleId="+roleId,dataSource.transport.options.destroy.url=dbServices.API_URL+"taskStatuses/DeleteTaskStatus?roleId="+roleId,dataSource.transport.options.create.url=dbServices.API_URL+"taskStatuses/InsertTaskStatus?roleId="+roleId,dataSource.read()}),$("#dispatcherGrid").kendoGrid({columns:[{field:"Name",title:"Name"},{width:55,field:"Color",title:"Color",editor:colorEditor,template:"<div class='gridColor' style='background-color: #=Color#'></div>"},{field:"RouteRequired",title:"Remove from Route on Selection",template:"#= dispatcherSettings.getChecked(RouteRequired)#"},{field:"DefaultTypeInt",title:"Attributes",template:"#= dispatcherSettings.getAttributeText(DefaultTypeInt) #"}],dataSource:dataSource,dataBound:onDataBound,editable:!0,scrollable:!1,selectable:!0,sortable:!0,save:function(){_.delay(function(){saveHistory.save()},200)}}),$("#dispatcher .k-grid-add").click(function(){dispatcherSettings.grid.addRow(),saveHistory.save()})},dispatcherSettings.show=function(){dispatcherSettings.setupSaveHistory()},dispatcherSettings.getChecked=function(checked){return checked===!0?"<input type='checkbox' checked onclick='dispatcherSettings.updateCheckbox(checked)'/>":"<input type='checkbox' onclick='dispatcherSettings.updateCheckbox(checked)' />"},dispatcherSettings.disableDefaultCheckboxes=function(){$("#dispatcher input[type='checkbox']").each(function(i){var typeInt=dispatcherSettings.grid._data[i].DefaultTypeInt;typeInt!==null&&(this.disabled=!0)})},dispatcherSettings.updateCheckbox=function(checked){selectedItem.set("RouteRequired",checked),saveHistory.save()};var addColorPicker=function(){$(".colorSelector2").ColorPicker({color:dispatcherSettings.grid.dataItem(dispatcherSettings.grid.select()).Color,onShow:function(colpkr){return $(colpkr).css("z-index","1000"),$(colpkr).fadeIn(200),!1},onHide:function(colpkr){return $(colpkr).fadeOut(200),!1},onChange:function(hsb,hex){var color="#"+hex;updateColor(color)}})},colorEditor=function(container,options){$("<input class='colorInput' data-text-field='Color' data-value-field='Color' data-bind='value:"+options.field+"'/>"+"<div class='customWidget'><div class='colorSelector2'><div class='innerSelector' style='background-color:"+options.model.Color+"'></div></div><div class='colorpickerHolder2'></div></div>").appendTo(container),addColorPicker()},updateColor=function(color){selectedItem.set("Color",color),saveHistory.save()};dispatcherSettings.getAttributeText=function(typeInt){return typeInt===1?"Default status for newly created tasks":typeInt===2?"Default status when placed into a route":typeInt===3?"Task completed":""};var onDataBound=function(){dispatcherSettings.grid=$("#dispatcherGrid").data("kendoGrid"),dispatcherSettings.originalData=dispatcherSettings.grid._data,dispatcherSettings.disableDefaultCheckboxes(),busAcctId=dispatcherSettings.grid._data[1].BusinessAccountId,dispatcherSettings.grid.bind("change",function(){enableOrDisableDelete(),selectedItem=dispatcherSettings.grid.dataItem(dispatcherSettings.grid.select())}),dispatcherSettings.grid.bind("edit",function(e){dispatcherSettings.disableDefaultCheckboxes(),e.sender._editContainer.context&&e.sender._editContainer.context.cellIndex==1&&$(".colorSelector2").ColorPickerShow(),e.model.BusinessAccountId||(e.model.BusinessAccountId=busAcctId),e.model.Id||(e.model.Id=tools.newGuid())})};dispatcherSettings.setupSaveHistory=function(){saveHistory.setCurrentSection({page:"Dispatcher Settings",save:function(){dispatcherSettings.grid.saveChanges()},section:dispatcherSettings})},dispatcherSettings.removeSelectedRow=function(){var row=getSelectedRow(dispatcherSettings.grid);dispatcherSettings.grid.removeRow(row),saveHistory.save()};var enableOrDisableDelete=function(){var row=getSelectedRow(dispatcherSettings.grid);row[0].cells[3].innerHTML!==""?$("#dispatcher .k-grid-delete").attr("disabled","disabled"):$("#dispatcher .k-grid-delete").removeAttr("disabled")},getSelectedRow=function(g){return g.tbody.find(".k-state-selected")};window.dispatcherSettings=dispatcherSettings})