// Copyright 2012 FoundOPS LLC. All Rights Reserved.

require(["jquery","db/services","tools","db/saveHistory","widgets/serviceDetails","lib/jquery.form"],function($,dbServices,tools,saveHistory){var services={},serviceHoldersDataSource,grid,handleChange,serviceTypesComboBox,selectedServiceHolder,vm;services.vm=vm=kendo.observable({selectedServiceType:function(){return serviceTypesComboBox.dataItem()}}),services.undo=function(state){dbServices.convertServiceDates(state),vm.set("selectedService",state),saveHistory.saveInputChanges("#serviceDetails"),services.save()},services.save=function(){dbServices.updateService(vm.get("selectedService")).success(function(e){var selectedRowId=grid.select().attr("data-uid"),selectedService=vm.get("selectedService");if(!selectedServiceHolder||!grid)return;selectedServiceHolder.set("ServiceId",selectedService.Id);var fields=selectedService.Fields;for(var i=0;i<fields.length;i++){var field=fields[i],val=field.get("Value");if(field.Type==="OptionsField"){val="";var options=field.Options;for(var o=0;o<options.length;o++)options[o].IsChecked&&(val+=options[o].Name+", ");val=val.substr(0,val.length-2)}var columnName=field.Name.split(" ").join("_");selectedServiceHolder.set(columnName,val)}handleChange=!0,grid.select(grid.table.find('tr[data-uid="'+selectedRowId+'"]'))})},services.exportToCSV=function(){var content=tools.toCSV(serviceHoldersDataSource.view(),"Services",!0,["RecurringServiceId","ServiceId"]),form=$("#csvForm");form.find("input[name=content]").val(content),form.find("input[name=fileName]").val("services.csv"),form[0].action=dbServices.ROOT_API_URL+"Helper/Download",form.submit()};var getDataSource=function(startDate,endDate,serviceType,callback){var formatResponse=function(data){var types=_.first(data),fields={};_.each(types,function(type,name){var field={},jType,detail;if(type==="System.Decimal")jType="number";else if(type==="System.DateTime")jType="date",detail="datetime";else if(type==="Time")jType="date",detail="time";else if(type==="Date")jType="date",detail="date";else{if(type!=="System.String"&&type!=="System.Guid")return;jType="string"}var fieldValues={type:jType,defaultValue:"",detail:detail};type==="System.Guid"&&(fieldValues.hidden=!0),fields[name]=fieldValues});var formattedData=[];_.each(_.rest(data),function(row){var formattedRow={};_.each(fields,function(value,key){var originalValue=row[key],convertedValue;if(originalValue===null)convertedValue="";else if(value.type==="number")convertedValue=parseFloat(originalValue);else if(value.type==="date")convertedValue=new Date(originalValue);else{if(value.type!=="string")return;convertedValue=originalValue.toString()}formattedRow[key]=convertedValue}),formattedData.push(formattedRow)}),serviceHoldersDataSource=new kendo.data.DataSource({data:formattedData,schema:{model:{id:"ServiceId",fields:fields}}}),serviceHoldersDataSource.sort({field:"OccurDate",dir:"asc"}),callback(fields,formattedData)};dbServices._getHttp("service/GetServicesHoldersWithFields",{startDate:tools.formatDate(startDate),endDate:tools.formatDate(endDate),serviceType:serviceType},!1)(formatResponse)},resizeGrid=function(initialLoad){var extraMargin;initialLoad?extraMargin=50:extraMargin=85;var windowHeight=$(window).height(),topHeight=$("#top").outerHeight(!0),contentHeight=windowHeight-topHeight-extraMargin;$("#grid").css("height",contentHeight+"px"),$("#grid .k-grid-content").css("height",contentHeight+"px")},saveGridConfig=function(){_.delay(function(){var columns=grid.columns,serviceColumns=[];for(var c in columns){var column={};column.Name=columns[c].field,column.Width=columns[c].width,column.Order=c,columns[c].hidden?column.Hidden=!0:column.Hidden=!1,serviceColumns.push(column)}var id=vm.selectedServiceType().Id;dbServices.updateServiceColumns(id,serviceColumns)},200)},setupGrid=function(fields){var columns=[];_.each(fields,function(value,key){if(value.hidden)return;var column={};column.title=key.split("_").join(" ").replace(/([A-Z])/g," $1"),column.field=key,column.type=value.type,column.type==="number"?column.template="#= ("+key+"== null) ? ' ' : "+key+" #":column.type==="date"&&(value.detail==="datetime"?column.template="#= ("+key+"== null) ? ' ' : moment("+key+").format('LLL') #":value.detail==="time"?column.template="#= ("+key+"== null) ? ' ' : moment("+key+").format('LT') #":value.detail==="date"&&(column.template="#= ("+key+"== null) ? ' ' : moment("+key+").format('LL') #"));var titleLength=column.title.length*7.5+35;column.width=titleLength+"px";var configColumn=_.find(services.serviceColumns,function(col){return col.Name===column.field});configColumn&&(configColumn.Width.indexOf("px")===-1&&(configColumn.Width+="px"),column.width=configColumn.Width,column.hidden=configColumn.Hidden,column.order=configColumn.Order),columns.push(column)});var storedCols=_.pluck(services.serviceColumns,"Name"),gridCols=_.pluck(columns,"field");(_.difference(storedCols,gridCols).length>0||_.difference(gridCols,storedCols).length>0)&&saveGridConfig(),columns=_(columns).sortBy(function(column){return column.order}),grid=$("#grid").kendoGrid({autoBind:!0,change:function(){if(handleChange){handleChange=!1;return}$("#services .k-grid-delete").removeAttr("disabled"),selectedServiceHolder=this.dataItem(this.select());if(!selectedServiceHolder)return;dbServices.getServiceDetails(selectedServiceHolder.get("ServiceId"),selectedServiceHolder.get("OccurDate"),selectedServiceHolder.get("RecurringServiceId"),function(service){services.vm.set("selectedService",service),saveHistory.close(),saveHistory.resetHistory(),saveHistory.saveInputChanges("#serviceDetails")})},columns:columns,columnMenu:!0,columnReorder:function(){saveGridConfig()},columnResize:function(){saveGridConfig()},columnShow:function(){saveGridConfig()},columnHide:function(){saveGridConfig()},dataSource:serviceHoldersDataSource,filterable:!0,resizable:!0,reorderable:!0,sortable:{mode:"multiple"},selectable:!0,scrollable:!0}).data("kendoGrid")};services.initialize=function(){dbServices.getServiceTypes(function(serviceTypes){services.serviceTypes=serviceTypes,serviceTypesComboBox=$("#serviceTypes").kendoDropDownList({dataTextField:"Name",dataValueField:"Id",dataSource:services.serviceTypes,change:function(){$("#services .k-grid-delete").attr("disabled","disabled"),services.serviceColumns!==null&&services.updateServices()}}).data("kendoDropDownList"),dbServices.getServiceColumns(function(columns){var id=vm.selectedServiceType().Id;services.serviceColumns=columns[id],services.updateServices()})});var startDatePicker=$("#startDatePicker"),endDatePicker=$("#endDatePicker");startDatePicker.kendoDatePicker({value:moment().toDate(),min:new Date(1950,0,1),max:new Date(2049,11,31),change:services.updateServices}),endDatePicker.kendoDatePicker({value:moment().add("weeks",2).toDate(),min:new Date(1950,0,1),max:new Date(2049,11,31),change:services.updateServices}),$("#serviceDetails").kendoServiceDetails(),services.updateServices=function(){var startDate=startDatePicker.data("kendoDatePicker").value(),endDate=endDatePicker.data("kendoDatePicker").value(),serviceTypeId=vm.selectedServiceType().Id;getDataSource(startDate,endDate,serviceTypeId,setupGrid)},$("#services .k-grid-delete").on("click",function(){var answer=confirm("Are you sure you want to delete the selected service?");answer&&(grid.dataSource.remove(selectedServiceHolder),dbServices.deleteService(vm.get("selectedService")))}),$(window).resize(function(){resizeGrid(!1)}),resizeGrid(!0)},services.show=function(){saveHistory.setCurrentSection({page:"Services",save:services.save,undo:services.undo,state:function(){return vm.get("selectedService")}})},window.services=services})