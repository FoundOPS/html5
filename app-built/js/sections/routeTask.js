// Copyright 2012 FoundOPS LLC. All Rights Reserved.

define(["jquery","db/services","db/saveHistory","lib/kendo.all","widgets/serviceDetails"],function($,dbServices,saveHistory){var routeTask={},vm,statusUpdated;routeTask.vm=vm=kendo.observable({openTaskStatuses:function(){$("#taskStatuses-actionsheet").kendoMobileActionSheet("open")},selectStatus:function(e){var statusId=e.dataItem.Id,task=vm.get("selectedTask");task.TaskStatusId=statusId,dbServices.updateRouteTask(task),updateSelectedStatus(),statusUpdated=!0}}),window.routeTask=routeTask;var updateSelectedStatus=function(){var selectedStatusId=vm.get("selectedTask.TaskStatusId"),selectedStatus=_.find(vm.get("taskStatusesSource").data(),function(status){return status.Id===selectedStatusId});vm.set("selectedTaskStatus",selectedStatus)};routeTask.undo=function(state){dbServices.convertServiceDates(state),vm.set("selectedService",state),saveHistory.saveInputChanges("#taskServiceDetails"),routeTask.save()},routeTask.save=function(){dbServices.updateService(vm.get("selectedService"))},$.subscribe("selectedTask",function(data){vm.set("selectedTask",data),dbServices.getServiceDetails(data.get("ServiceId"),data.get("Date"),data.get("RecurringServiceId"),function(service){vm.set("selectedService",service),saveHistory.close(),saveHistory.resetHistory(),saveHistory.saveInputChanges("#taskServiceDetails")}),dbServices.getTaskStatuses(function(response){var taskStatuses=new kendo.data.DataSource({data:response});vm.set("taskStatusesSource",taskStatuses),updateSelectedStatus()})}),$.subscribe("hashChange",function(data){data.comingFrom==="#view/routeTask.html"&&data.goingTo==="#view/routeDestinationDetails.html"&&(statusUpdated||$("#taskStatuses-actionsheet").kendoMobileActionSheet("open"))}),routeTask.initialize=function(){$("#taskServiceDetails").kendoServiceDetails()},routeTask.show=function(){statusUpdated=!1,saveHistory.close();if(!vm.get("selectedTask")){application.navigate("view/routeDestinationDetails.html");return}saveHistory.setCurrentSection({page:"Route Task",save:routeTask.save,undo:routeTask.undo,state:function(){return vm.get("selectedService")}})}})