// Copyright 2012 FoundOPS LLC. All Rights Reserved.

define(["db/services","db/saveHistory","db/session","widgets/imageUpload","widgets/settingsMenu"],function(dbServices,saveHistory,session){var businessSettings={},imageUpload,vm=kendo.observable();businessSettings.vm=vm,businessSettings.undo=function(state){vm.set("settings",state),businessSettings.save()},businessSettings.save=function(){businessSettings.validator.validate()&&dbServices.updateBusinessSettings(vm.get("settings"))},businessSettings.initialize=function(){businessSettings.validator=$("#businessForm").kendoValidator().data("kendoValidator");var menu=$("#business .settingsMenu");kendo.bind(menu),menu.kendoSettingsMenu({selectedItem:"Business"}),saveHistory.saveInputChanges("#business"),dbServices.getBusinessSettings(function(settings){businessSettings.settings=settings,vm.set("settings",settings),kendo.bind($("#business"),vm),imageUpload.setImageUrl(vm.get("settings.ImageUrl")),saveHistory.resetHistory()}),imageUpload=$("#businessImageUpload").kendoImageUpload({uploadUrl:dbServices.API_URL+"settings/UpdateBusinessImage",imageWidth:200,containerWidth:500}).data("kendoImageUpload"),session.followRole(function(role){imageUpload.setUploadUrl(dbServices.API_URL+"settings/UpdateBusinessImage?roleId="+role.get("id"))})},businessSettings.show=function(){saveHistory.setCurrentSection({page:"Business Settings",save:businessSettings.save,undo:businessSettings.undo,state:function(){return vm.get("settings")}})},window.businessSettings=businessSettings})