// Copyright 2012 FoundOPS LLC. All Rights Reserved.

define(["db/services","db/session","db/saveHistory","tools","widgets/settingsMenu"],function(dbServices,session,saveHistory,tools){var usersSettings={},usersDataSource,linkedEmployees;usersSettings.matchEmployee=function(){var dropDownList=$("#Employee").data("kendoDropDownList"),name=$("#FirstName")[0].value+" "+$("#LastName")[0].value;dropDownList.select(function(dataItem){return dataItem.DisplayName===name})},usersSettings.setupSaveHistory=function(){saveHistory.setCurrentSection({page:"Users Settings",section:usersSettings})},usersSettings.availableEmployeesDataSource=new kendo.data.DataSource({});var fields={Id:{type:"hidden",defaultValue:""},FirstName:{type:"string",validation:{required:!0},defaultValue:""},LastName:{type:"string",validation:{required:!0},defaultValue:""},EmailAddress:{type:"string",validation:{required:!0},defaultValue:""},Role:{type:"string",validation:{required:!0},defaultValue:""},Employee:{defaultValue:""},TimeZoneInfo:{defaultValue:""}};usersDataSource=new kendo.data.DataSource({transport:{read:{type:"GET",dataType:"jsonp",contentType:"application/json; charset=utf-8",complete:function(jqXHR,textStatus){textStatus=="error"&&saveHistory.error("Get")}},create:{type:"POST"},update:{type:"POST"},destroy:{type:"POST"}},schema:{model:{id:"Id",fields:fields}},change:function(e){linkedEmployees={},_.each(e.items,function(obj){obj.Employee&&(linkedEmployees[obj.Employee.LinkedUserAccountId]=obj)})}}),dbServices.hookupDefaultComplete(usersDataSource),session.followRole(function(role){var roleId=session.get("role.id");if(!roleId)return;if(role.type!=="Administrator")return;usersDataSource.transport.options.read.url=dbServices.API_URL+"settings/GetAllUserSettings?roleId="+roleId,usersDataSource.transport.options.update.url=dbServices.API_URL+"settings/UpdateUserSettings?roleId="+roleId,usersDataSource.transport.options.destroy.url=dbServices.API_URL+"settings/DeleteUserSettings?roleId="+roleId,usersDataSource.transport.options.create.url=dbServices.API_URL+"settings/InsertUserSettings?roleId="+roleId,usersDataSource.read()});var setupAddNewUser=function(){$("#addUser").on("click",function(){var availableEmployees=usersSettings.employees.filter(function(employee){return!(employee.Id in linkedEmployees)}),createNew={DisplayName:"Create New",FirstName:"",Id:"1",LastName:"",LinkedUserAccountId:""};availableEmployees.push(createNew);var object=$("<div id='popupEditor'>").appendTo($("body")).kendoWindow({title:"Add New User",modal:!0,content:{template:kendo.template($("#createTemplate").html())}}).data("kendoWindow").center(),index=usersDataSource.indexOf((usersDataSource.view()||[])[0]);index<0&&(index=0);var model=usersDataSource.insert(index,{});kendo.bind(object.element,model),model.Role="Administrator";var validator=$(object.element).kendoValidator().data("kendoValidator");$("#Employee").kendoDropDownList({dataSource:availableEmployees,dataTextField:"DisplayName",dataValueField:"DisplayName"});var selectDefaultEmployee=function(){var dropDownList=$("#Employee").data("kendoDropDownList");$("#Role")[0].value==="Mobile"?dropDownList.select(function(dataItem){return dataItem.DisplayName==="None "}):dropDownList.select(function(dataItem){return dataItem.DisplayName==="Create New"})};selectDefaultEmployee(),$("#Role").on("change",function(){selectDefaultEmployee()}),$("#btnAdd").on("click",function(){if(validator.validate()){var employee=$("#Employee")[0].value;if(employee==="None")usersDataSource._data[0].Employee={FirstName:"None",Id:" ",LastName:" ",LinkedUserAccountId:" "};else if(employee==="Create New")usersDataSource._data[0].Employee={FirstName:"Create",Id:" ",LastName:" ",LinkedUserAccountId:" "};else{var name=employee.split(" ");usersDataSource._data[0].Employee={FirstName:name[0],Id:" ",LastName:name[1],LinkedUserAccountId:" "}}usersDataSource._data[0].TimeZoneInfo=tools.getLocalTimeZone(),usersDataSource.sync();var grid=$("#usersGrid").data("kendoGrid");$("#usersGrid")[0].childNodes[0].childNodes[2].childNodes[0].childNodes[4].innerText=employee,grid._data[0].Employee.DisplayName=employee,object.close(),object.element.remove()}}),$("#btnCancel").on("click",function(){usersDataSource.cancelChanges(model),object.close(),object.element.remove()}),$(".k-i-close").on("click",function(){usersDataSource.cancelChanges(model)})})},setupUsersGrid=function(){$("#usersGrid").kendoGrid({dataSource:usersDataSource,dataBound:function(){$(".k-grid-edit").each(function(){$(this).attr("title","Edit")}),$(".k-grid-delete").each(function(){$(this).attr("title","Delete")})},editable:{mode:"popup",template:$("#editTemplate").html(),confirmation:"Are you sure you want to delete this user?"},edit:function(e){var availableEmployees=usersSettings.employees.filter(function(employee){return!(employee.LinkedUserAccountId in linkedEmployees)});e.model.Employee&&availableEmployees.push(e.model.Employee),usersSettings.availableEmployeesDataSource.data(availableEmployees),$(".k-grid-cancel").on("click",function(){e.sender.cancelChanges()}),$(".k-i-close").on("click",function(){e.sender.cancelChanges()})},saveChanges:function(){saveHistory.success()},scrollable:!1,sortable:!0,columns:[{field:"FirstName",title:"First Name"},{field:"LastName",title:"Last Name"},{field:"EmailAddress",title:"Email"},{field:"Role"},{field:"Employee",title:"Employee Record",template:"# if (Employee && Employee.DisplayName) {##= Employee.DisplayName ## } #"},{command:["edit","destroy"],width:"81px"}]})};usersSettings.initialize=function(){dbServices.getAllEmployeesForBusiness(function(employees){usersSettings.employees=employees});var menu=$("#users .settingsMenu");kendo.bind(menu),menu.kendoSettingsMenu({selectedItem:"Users"}),setupAddNewUser(),setupUsersGrid()},usersSettings.show=function(){usersSettings.setupSaveHistory()},window.usersSettings=usersSettings})