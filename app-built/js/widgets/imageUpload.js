define(["tools","db/saveHistory","db/services","jquery","lib/kendo.all","lib/jquery-ui-1.8.21.core.min","lib/jquery.FileReader","lib/swfobject","lib/jquery.form"],function(tools,saveHistory,dbServices,$){var kendo=window.kendo,ui=kendo.ui,Widget=ui.Widget,template='<img class="imageupload-cropbox"/><a class="k-button k-button-icontext imageupload-button"><span class="k-icon k-image"></span>Upload Image</a><form enctype="multipart/form-data" method="POST"><input type="hidden" name="imageFileName"/><input type="hidden" name="imageData"/></form>',ImageUpload=Widget.extend({init:function(element,options){var that=this,templateElement,imageUploadButton;Widget.fn.init.call(that,element,options),templateElement=$(template),that.cropBox=$(templateElement[0]),that.form=$(templateElement[2]),that.imageFileNameField=templateElement.find("input[name=imageFileName]"),that.imageDataField=templateElement.find("input[name=imageData]"),that.newImage=!1,that.cropBox.on("load",function(){tools.resizeImage(that.cropBox,that.options.imageWidth,that.options.containerWidth)}),imageUploadButton=$(templateElement[1]),imageUploadButton.fileReader(),imageUploadButton.on("change",function(evt){that._changeImage(evt)}),that.element.append(templateElement)},_changeImage:function(evt){var that=this,reader=new FileReader;reader.onload=function(evt){var imageData=evt.target.result;if(imageData===null)return;that.cropBox.attr("src",imageData),that.imageDataField.val(imageData),that.cropBox.css("visibility","visible").css("width","auto").css("height","auto"),that.newImage=!0,tools.resizeImage(that.cropBox,that.options.imageWidth,that.options.containerWidth),that.submitForm()};var file=evt.target.files[0];if(!file.name.match(/(.*\.png$)/)&&!file.name.match(/(.*\.jpg$)/)&&!file.name.match(/(.*\.JPG$)/)&&!file.name.match(/(.*\.gif$)/)){saveHistory.error("The File Type must be .png, .jpg, or .gif");return}if(file.size>5e6){saveHistory.error("File Size cannot be larger than 10MB");return}reader.readAsDataURL(file),that.imageFileNameField.val(file.name),tools.resizeImage(that.cropBox,that.options.imageWidth,that.options.containerWidth)},events:["uploaded"],setUploadUrl:function(url){this.options.uploadUrl=url},setImageFields:function(data,fileName){var that=this;that.newImage=!0,that.imageDataField.val(data),that.imageFileNameField.val(fileName),data!==null&&that.setImageUrl(data),tools.resizeImage(that.cropBox,that.options.imageWidth,that.options.containerWidth)},submitForm:function(){var that=this;that.newImage&&that.imageDataField.val()&&that.form.ajaxSubmit({dataType:"text",contentType:"multipart/form-data",url:that.options.uploadUrl,success:function(response){var url=response.replace(/['"]/g,"");that.setImageUrl(url),_.delay(function(){that.setImageUrl(url)},1500),that.newImage=!1,that.trigger("uploaded",{data:that.imageDataField[0].value,fileName:that.imageFileNameField[0].value}),saveHistory.success()},error:function(){saveHistory.error("Image upload failed")}})},setImageUrl:function(imageUrl){this.imageUrl=imageUrl,this.cropBox.attr("src",imageUrl),this.options.imageDataBinding=this.imageDataField,this.options.imageFileNameBinding=this.imageFileNameField},options:new kendo.data.ObservableObject({name:"ImageUpload",uploadUrl:"",imageWidth:200,containerWidth:500})});ui.plugin(ImageUpload)})