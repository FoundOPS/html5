// Copyright 2012 FoundOPS LLC. All Rights Reserved.

define(["db/models","tools","ui/ui","lib/leaflet"],function(models,tools,ui){var leaflet={};leaflet.setupMap=function(){var map=new window.L.Map("map",{center:new window.L.LatLng(40,-89),zoom:4}),cloudMade=new window.L.TileLayer("http://{s}.tile.cloudmade.com/57cbb6ca8cac418dbb1a402586df4528/997/256/{z}/{x}/{y}.png",{maxZoom:18});return map.addLayer(cloudMade),map},leaflet.center=function(map,locations){var bounds=new window.L.LatLngBounds(locations);map.fitBounds(bounds)},leaflet.addPopup_=function(marker,content){marker.bindPopup(content,{closeButton:!1,autoPan:!1}),marker.on("mouseover",function(e){e.target.openPopup()}),marker.on("mouseout",function(e){e.target.closePopup()})},leaflet.getLatLng=function(location){return new window.L.LatLng(location.Latitude,location.Longitude)};var addMarkerClick=function(marker,opt_selected){marker.on("click",function(e){opt_selected(e.target.options.icon.routeId)})};return leaflet.drawDepot_=function(layer,depot){var location=leaflet.getLatLng(depot),Icon=window.L.Icon.extend({iconUrl:ui.ImageUrls.DEPOT,shadowUrl:null,iconSize:new window.L.Point(24,18),iconAnchor:new window.L.Point(12,9),shadowSize:new window.L.Point(0,0),popupAnchor:new window.L.Point(0,-10)}),depotIcon=new Icon,marker=new window.L.Marker(location,{icon:depotIcon});leaflet.addPopup_(marker,"<b>"+depot.Name+"</b>"),layer.addLayer(marker)},leaflet.drawDepots=function(map,depots){var depotsGroup=new window.L.LayerGroup,d;for(d in depots){var depot=depots[d];leaflet.drawDepot_(depotsGroup,depot)}return map.addLayer(depotsGroup),depotsGroup},leaflet.drawResource_=function(layer,resource,routeColorSelector,opt_routeSelected){var rotateDegrees=resource.Heading,color=routeColorSelector.getValue(resource.RouteId),locationLatLng=new window.L.LatLng(resource.Latitude,resource.Longitude),iconUrl=ui.ImageUrls.TRUCK;resource.Source===models.DevicePlatform.IPHONE?iconUrl=ui.ImageUrls.APPLE:resource.Source===models.DevicePlatform.ANDROID&&(iconUrl=ui.ImageUrls.ANDROID);var circleMarker=new window.L.CircleMarker(locationLatLng,{radius:10.5,weight:.5,opacity:1,color:color,fillOpacity:1,fillColor:color,clickable:!1});layer.addLayer(circleMarker);var resourceIcon=new window.L.Icon;$.extend(resourceIcon,{iconUrl:iconUrl,shadowUrl:null,iconSize:new window.L.Point(14,14),iconAnchor:new window.L.Point(7,7),shadowSize:new window.L.Point(0,0),popupAnchor:new window.L.Point(0,-7),routeId:resource.RouteId});var popupContent="<p class='speed'><b>"+resource.EntityName+"</b><br />Speed: "+Math.round(resource.Speed)+" mph "+tools.getDirection(rotateDegrees)+"</p>",iconMarker=new window.L.Marker(locationLatLng,{icon:resourceIcon});leaflet.addPopup_(iconMarker,popupContent),layer.addLayer(iconMarker);var arrowIcon=new window.L.Icon;$.extend(arrowIcon,{routeId:resource.RouteId,iconUrl:ui.ImageUrls.OUTER_CIRCLE,shadowUrl:null,iconSize:new window.L.Point(18.5,18.5),iconAnchor:new window.L.Point(9,9),shadowSize:new window.L.Point(0,0),popupAnchor:new window.L.Point(0,-9),initialize:function(options){window.L.Util.setOptions(this,options)}});var arrowMarker=new window.L.Marker(locationLatLng,{icon:arrowIcon,angle:rotateDegrees,_reset:function(){var pos=this._map.latLngToLayerPoint(this._latlng).round();window.L.DomUtil.setPosition(this._icon,pos);var rotateString="rotate("+this.options.angle+"deg)";this._icon.style.WebkitTransform+=rotateString,this._icon.style.MozTransform=rotateString,this._icon.style.msTransform=rotateString,this._icon.style.OTransform=rotateString}});leaflet.addPopup_(arrowMarker,popupContent),opt_routeSelected&&addMarkerClick(arrowMarker,opt_routeSelected),layer.addLayer(arrowMarker)},leaflet.drawResources=function(map,resources,routeColorSelector,opt_routeSelected){var resourcesGroup=new window.L.LayerGroup,r;for(r in resources){var resource=resources[r];leaflet.drawResource_(resourcesGroup,resource,routeColorSelector,opt_routeSelected)}return map.addLayer(resourcesGroup),resourcesGroup},leaflet.drawDestination_=function(layer,destination,routeId,routeColorSelector,opt_routeSelected){var location=destination.Location,locationLatLng=leaflet.getLatLng(location),destinationIcon=new window.L.Icon;$.extend(destinationIcon,{number:destination.OrderInRoute,routeId:routeId,popupAnchor:new window.L.Point(0,-7),options:{className:"leaflet-div-icon"},createIcon:function(){var div=document.createElement("div"),numdiv=document.createElement("div");return numdiv.setAttribute("class","number"),destination.OrderInRoute>9&&destination.OrderInRoute<100?numdiv.style.left="-5px":destination.OrderInRoute>=100&&(numdiv.style.top="-4px",numdiv.style.left="-5px",numdiv.style.fontSize="6.4px"),numdiv.innerHTML=this.number||"",div.appendChild(numdiv),this._setIconStyles(div,"icon"),div},createShadow:function(){return null},initialize:function(options){window.L.Util.setOptions(this,options)},_setIconStyles:function(img,name){var options=this.options,size=options[name+"Size"],anchor=options.iconAnchor;img.className="leaflet-marker-"+name+" "+options.className,anchor&&(img.style.marginLeft=-anchor.x+"px",img.style.marginTop=-anchor.y+"px"),size&&(img.style.width=size.x+"px",img.style.height=size.y+"px")}});var numMarker=new window.L.Marker(locationLatLng,{icon:destinationIcon}),marker=new window.L.CircleMarker(locationLatLng,{radius:7,opacity:1,weight:1,color:"#ffffff",fillColor:routeColorSelector.getValue(routeId),fillOpacity:1,clickable:!1});return opt_routeSelected&&addMarkerClick(numMarker,opt_routeSelected),leaflet.addPopup_(numMarker,"<b>"+location.Name+"</b>"),layer.addLayer(marker),layer.addLayer(numMarker),locationLatLng},leaflet.drawRoutes=function(map,routes,routeColorSelector,shouldCenter,opt_routeSelected){var destinationLatLngs=[],routesGroup=new window.L.LayerGroup,r;for(r in routes){var route=routes[r],d;for(d in route.RouteDestinations){var destination=route.RouteDestinations[d],latLng=leaflet.drawDestination_(routesGroup,destination,route.Id,routeColorSelector,opt_routeSelected);destinationLatLngs.push(latLng)}}return map.addLayer(routesGroup),shouldCenter&&leaflet.center(map,destinationLatLngs),routesGroup},leaflet.drawTrackPoint_=function(polyline,trackPoint){var lat=trackPoint.Latitude,lng=trackPoint.Longitude,location=new window.L.LatLng(lat,lng);polyline.addLatLng(location)},leaflet.drawTrackPoints=function(map,trackpoints,resources,routeColorSelector,routeOpacitySelector,routeId){var trackPointsGroup=new window.L.LayerGroup,r;for(r in resources)if(resources[r].RouteId===routeId){var resourceId;resources[r].EmployeeId!==null?resourceId=resources[r].EmployeeId:resourceId=resources[r].VehicleId;var latlngs=[],polyline=new window.L.Polyline(latlngs,{color:routeColorSelector.getValue(routeId),weight:2,opacity:routeOpacitySelector.getValue(resourceId),clickable:!1}),t;for(t in trackpoints)if(trackpoints[t].Id===resourceId&&trackpoints[t].RouteId===routeId){var trackPoint=trackpoints[t];leaflet.drawTrackPoint_(polyline,trackPoint)}trackPointsGroup.addLayer(polyline)}return map.addLayer(trackPointsGroup),trackPointsGroup},leaflet})