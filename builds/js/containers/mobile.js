// Copyright 2012 FoundOPS LLC. All Rights Reserved.

require.config({waitSeconds:10,baseUrl:"js",paths:{lib:"../lib",ui:"ui",db:"db",cordova:"../lib/cordova-1.8.1",underscore:"../lib/underscore"},shim:{cordova:{exports:"c"},underscore:{exports:"_"}}}),require(["jquery","lib/kendo.mobile.min","developer","db/services","db/models"],function($,k,developer,services,models){function onDeviceReady(){mobile.CONFIG.DEVICE_PLATFORM=device.platform}var mobile={};mobile.CONFIG={TRACKPOINT_COLLECTION_FREQUENCY_SECONDS:1,ACCURACY_THRESHOLD:50},document.addEventListener("deviceready",onDeviceReady,!1);var app,serviceDate,intervalId=null,trackPointsToSend=[],addPushTrackPoints=function(routeId){var onSuccess=function(position){console.log("Position: "+position.coords.latitude+" "+position.coords.longitude);var collectedTime=new Date(position.timestamp),newTrackPoint=new models.TrackPoint(position.coords.accuracy,collectedTime,position.coords.heading,position.coords.latitude,position.coords.longitude,routeId,mobile.CONFIG.DEVICE_PLATFORM,position.coords.speed);trackPointsToSend.push(newTrackPoint),services.postTrackPoints(trackPointsToSend,routeId,function(e){e&&(trackPointsToSend=[])})},onError=function(error){console.log("Error Code: "+error.code+"\n"+error.message)};navigator.geolocation.getCurrentPosition(onSuccess,onError,{enableHighAccuracy:!0})};mobile.viewModel=kendo.observable({routesSource:services.routesDataSource,selectRoute:function(e){this.set("selectedRoute",e.dataItem),this.set("routeDestinationsSource",new kendo.data.DataSource({data:this.get("selectedRoute").RouteDestinations})),app.navigate("views/routeDetails.html")},selectRouteDestination:function(e){this.set("selectedDestination",e.dataItem),this.set("destinationPhoneContactInfoSource",new kendo.data.DataSource({data:this.get("selectedDestination").Location.ContactInfoSet,filter:{field:"Type",operator:"equal",value:"Phone Number"}})),this.set("destinationEmailContactInfoSource",new kendo.data.DataSource({data:this.get("selectedDestination").Location.ContactInfoSet,filter:{field:"Type",operator:"equal",value:"Email Address"}})),this.set("destinationWebsiteContactInfoSource",new kendo.data.DataSource({data:this.get("selectedDestination").Location.ContactInfoSet,filter:{field:"Type",operator:"equal",value:"Website"}})),app.navigate("views/routeDestinationDetails.html")},startVisible:!0,endVisible:!1,startRoute:function(){var that=this;that.set("startVisible",!1),that.set("endVisible",!0),serviceDate=new Date,intervalId=window.setInterval(function(){addPushTrackPoints(that.get("selectedRoute").Id)},mobile.CONFIG.TRACKPOINT_COLLECTION_FREQUENCY_SECONDS*1e3)},endRoute:function(){this.set("startVisible",!0),this.set("endVisible",!1);var date=new Date;clearInterval(intervalId),trackPointsToSend=[]}}),mobile.login=function(){var e=$("#email").val(),p=$("#pass").val();services.authenticate(e,p,function(data){data?app.navigate("views/routeList.html"):alert("Login information is incorrect.")})},mobile.logout=function(){services.logout(function(data){data?app.navigate("mobile.html"):alert("Logout cannot be completed at this time.")})},mobile.navToRoutesList=function(){app.navigate("views/routeList.html")},window.mobile=mobile,app=new kendo.mobile.Application($(document.body),{})})